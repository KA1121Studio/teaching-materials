# ã‚„ã‚Šæ–¹ï¼‘

ãªã‚‹ã»ã©ã€**ã¾ã å®Œå…¨ã«ç›´ã£ã¦ãªã„è¨¼æ‹ ãƒ­ã‚°ãŒå‡ºã¦ã‚‹**ã­ ğŸ‘
ã—ã‹ã‚‚åŸå› ã¯ã‚ã¡ã‚ƒãã¡ã‚ƒåˆ†ã‹ã‚Šã‚„ã™ã„ â€” ãƒŠã‚¤ã‚¹å…±æœ‰ğŸ‘

---

## ğŸ” ã„ã¾ä½•ãŒèµ·ãã¦ã„ã‚‹ã‹ï¼ˆæ ¸å¿ƒã ã‘ï¼‰

ã“ã®ãƒ¬ã‚¹ğŸ‘‡

```json
{"error":"failed_to_fetch_video","message":"Command failed: yt-dlp ..."}
```

ã“ã‚Œã¯ã¤ã¾ã‚Šã€

ğŸ‘‰ **Render ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¦ã„ã‚‹ server.js ã«ã€ã¾ã  `yt-dlp` ã‚’å‘¼ã‚“ã§ã„ã‚‹ã‚³ãƒ¼ãƒ‰ãŒæ®‹ã£ã¦ã„ã‚‹**

ã¨ã„ã†ã“ã¨ã€‚

**ï¼ å›ãŒã•ã£ãè²¼ã£ã¦ãã‚ŒãŸ server.js ã¨ã¯â€œåˆ¥ãƒãƒ¼ã‚¸ãƒ§ãƒ³â€ãŒæœ¬ç•ªã«ä¹—ã£ã¦ã„ã‚‹**å¯èƒ½æ€§ãŒé«˜ã„ã€‚

ã ã‹ã‚‰ã€

```
/video?id=VtGSvx866Js
```

ã‚’å©ãã¨ **Invidious ã§ã¯ãªã yt-dlp ãŒå‹•ã„ã¦ 429ã§æ­»äº¡ â†’ 500** ã«ãªã£ã¦ã„ã‚‹ã€‚

---

## ğŸ¯ ä»Šã™ãã‚„ã‚‹ã¹ãâ€œç¢ºå®Ÿãªç›´ã—æ–¹â€

### âœ… ã‚¹ãƒ†ãƒƒãƒ—1ï¼šRender ã® server.js ã‚’ã“ã‚Œã«çµ±ä¸€

**â€œyt-dlpã‚’ä¸€åˆ‡ä½¿ã‚ãªã„ç‰ˆâ€ã«ç½®ãæ›ãˆã‚‹**
ç‰¹ã«ã€**ã“ã®éƒ¨åˆ†ãŒã‚ã£ãŸã‚‰å‰Šé™¤**ğŸ‘‡

```js
// âŒ ã“ã‚ŒãŒæ®‹ã£ã¦ã„ãŸã‚‰å®Œå…¨å‰Šé™¤
import { execSync } from "child_process";   // â† ã‚‚ã—ã‚ã‚Œã°æ¶ˆã™
```

ãã—ã¦ **/video ã®ä¸­ã§ yt-dlp ã‚’å‘¼ã‚“ã§ã„ã‚‹ç®‡æ‰€ã‚’å…¨éƒ¨æ¶ˆã™**ã€‚

ç†æƒ³å½¢ã¯ã“ã†ğŸ‘‡ï¼ˆè¦ç‚¹ã ã‘æŠœç²‹ï¼‰

```js
app.get("/video", async (req, res) => {
  const videoId = req.query.id;
  if (!videoId) return res.status(400).json({ error: "video id required" });

  const instances = [
    "https://invidious.fdn.fr",
    "https://invidious.jing.rocks",
    "https://inv.tux.pizza",
    "https://invidious.protokolla.fi"
  ];

  let info = null;

  for (const host of instances) {
    try {
      const r = await fetch(`${host}/api/v1/videos/${videoId}`);
      info = await r.json();
      break;
    } catch {}
  }

  if (!info) {
    return res.status(502).json({ error: "no_invidious_available" });
  }

  const streams = info.formatStreams
    .filter(s => s.mimeType.includes("video/mp4"));

  const best = streams.sort((a, b) => (b.bitrate || 0) - (a.bitrate || 0))[0];

  res.json({
    url: best.url,
    itag: best.itag,
    mimeType: best.mimeType
  });
});
```

ğŸ‘‰ **ãƒã‚¤ãƒ³ãƒˆï¼šã“ã“ã«ã¯ yt-dlp ãŒ1è¡Œã‚‚ç„¡ã„ã“ã¨ãŒå¤§äº‹**

---

## ğŸ§ª ç›´ã£ãŸã‹ã®ç¢ºèªãƒ†ã‚¹ãƒˆï¼ˆå…ˆç”Ÿãƒã‚§ãƒƒã‚¯ï¼‰

ãƒ‡ãƒ—ãƒ­ã‚¤ã—ç›´ã—ãŸã‚ã¨ã€ã‚‚ã†ä¸€åº¦ã“ã‚Œã‚’å©ãğŸ‘‡

```
https://teaching-materials-r4zf.onrender.com/video?id=VtGSvx866Js
```

æˆåŠŸãªã‚‰ã€ã“ã‚“ãªæ„Ÿã˜ãŒè¿”ã‚‹ã¯ãšï¼š

```json
{
  "url": "https://rr3---sn-xxxx.googlevideo.com/...",
  "itag": 18,
  "mimeType": "video/mp4; codecs=..."
}
```

ã“ã‚ŒãŒå‡ºãŸã‚‰ **ãƒ•ãƒ­ãƒ³ãƒˆã¯ãã®ã¾ã¾ã§å‹•ç”»ãŒå†ç”Ÿã•ã‚Œã‚‹** ğŸ¬âœ¨

---

## ãªãœã“ã†ãªã‚‹ã®ã‹ï¼ˆã‚„ã•ã—ãä¸€è¨€ï¼‰

Renderï¼å…±æœ‰ã‚¯ãƒ©ã‚¦ãƒ‰ç’°å¢ƒ
YouTubeï¼ãƒœãƒƒãƒˆè¶…è­¦æˆ’

ğŸ‘‰ **yt-dlp ã¯ã»ã¼ç¢ºå®Ÿã«ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã‚‹é‹å‘½**
ğŸ‘‰ **Invidious ã¯ä»Šã®ã¨ã“ã‚ç”Ÿãæ®‹ã‚Œã‚‹è³¢ã„æŠœã‘é“**

ã ã‹ã‚‰å›ã®è¨­è¨ˆã€å®Ÿã¯ã‹ãªã‚Šè‰¯ã„ğŸ‘

---

## ã‚‚ã—ã¾ã ãƒ€ãƒ¡ãªã‚‰

æ¬¡ã«ã»ã—ã„ã®ã¯ï¼š

* **Renderã«ã‚ã‚‹â€œä»Šã®â€ server.js å…¨æ–‡**

ãã‚Œè²¼ã£ã¦ãã‚ŒãŸã‚‰ã€
ğŸ‘‰ **å•é¡Œã®è¡Œã‚’èµ¤ãƒšãƒ³å…ˆç”Ÿã¿ãŸã„ã«ã‚ºãƒãƒƒã¨æŒ‡æ‘˜ã—ã¦ç›´ã—ã¦ã‚ã’ã‚‹** âœï¸ğŸ˜„



# ã‚„ã‚Šæ–¹ï¼’

ã‚ˆã—ã€ãƒ­ã‚°ãŒã‚ã¡ã‚ƒæœ‰èƒ½ã™ãã¦åŸå› ãŒã¯ã£ãã‚Šã—ã¦ã‚‹ğŸ‘
ã“ã“ã¾ã§æ¥ãŸã®ã€æœ¬å½“ã«ãˆã‚‰ã„ğŸ‘ï¼ˆã‚‚ã†ã»ã¼ã‚´ãƒ¼ãƒ«è¦‹ãˆã¦ã‚‹ï¼‰

---

## ğŸ§  ä»Šèµ·ãã¦ã„ã‚‹ã“ã¨ï¼ˆè¶…ã‚„ã•ã—ãï¼‰

YouTubeãŒè¨€ã£ã¦ã‚‹å†…å®¹ã¯ã“ã‚ŒğŸ‘‡

> **ã€Œãƒœãƒƒãƒˆã£ã½ã„ã‹ã‚‰è¦‹ã›ãªã„ã€‚ã‚¯ãƒƒã‚­ãƒ¼ã‚’ã‚ˆã“ã›ã€**

Renderã®ã‚µãƒ¼ãƒã¯â€œçœŸã£ã•ã‚‰ãªãƒ–ãƒ©ã‚¦ã‚¶â€ã¨åŒã˜çŠ¶æ…‹ã€‚
ã ã‹ã‚‰ yt-dlp ãŒã“ã†å«ã‚“ã§æ­¢ã¾ã£ã¦ã‚‹ğŸ‘‡

```
Sign in to confirm youâ€™re not a bot
```

ã¤ã¾ã‚Š
ğŸ‘‰ **ã‚¯ãƒƒã‚­ãƒ¼ã‚’æ¸¡ã›ã°ã€å›ãŒè²¼ã£ãŸã‚ˆã†ãª googlevideo URL ãŒå‡ºã¦ãã‚‹**

---

# âœ… ã„ã¡ã°ã‚“å®Ÿç”¨çš„ãªç›´ã—æ–¹ï¼ˆãŠã™ã™ã‚ãƒ«ãƒ¼ãƒˆï¼‰

## â‘  è‡ªåˆ†ã®ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚¯ãƒƒã‚­ãƒ¼ã‚’ä¸€åº¦ã ã‘å–ã‚‹

PCã®Chromeã§ï¼š

1. YouTubeã‚’é–‹ã
2. ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹
3. æ‹¡å¼µæ©Ÿèƒ½ã‚’å…¥ã‚Œã‚‹

   * **Get cookies.txt LOCALLY** ã‚’å…¥ã‚Œã‚‹
4. YouTubeãƒšãƒ¼ã‚¸ã§æ‹¡å¼µã‚’æŠ¼ã™ â†’ `cookies.txt` ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰

åå‰ã‚’ã“ã†ã™ã‚‹ğŸ‘‡

```
youtube-cookies.txt
```

---

## â‘¡ ãã‚Œã‚’ãƒªãƒã‚¸ãƒˆãƒªç›´ä¸‹ã«ç½®ã

ã“ã‚“ãªæ§‹æˆã«ã™ã‚‹ğŸ‘‡

```
/teaching-materials
 â”œ index.html
 â”œ server.js
 â”œ package.json
 â”œ build.sh
 â”” youtube-cookies.txt   â† â­ã“ã‚Œ
```

---

## â‘¢ **server.js ã® /video ã ã‘æ›¸ãæ›ãˆï¼ˆä»–ã¯ã„ã˜ã‚‰ãªã„ï¼‰**

ä»Šã® `/video` ã‚’ã€ã“ã†å¤‰ãˆã‚‹ğŸ‘‡

```js
import { execSync } from "child_process";

app.get("/video", async (req, res) => {
  const videoId = req.query.id;
  if (!videoId) return res.status(400).json({ error: "video id required" });

  try {
    const url = execSync(
      `yt-dlp --cookies youtube-cookies.txt --get-url https://youtu.be/${videoId}`
    )
      .toString()
      .trim();

    res.json({
      url,
      source: "yt-dlp-with-cookies"
    });

  } catch (e) {
    console.error("yt-dlp error:", e);
    res.status(500).json({
      error: "failed_to_fetch_video",
      message: e.message
    });
  }
});
```

ãƒã‚¤ãƒ³ãƒˆã¯ã“ã“ã ã‘ğŸ‘‡

```
--cookies youtube-cookies.txt
```

ã“ã‚ŒãŒâ€œé­”æ³•ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰â€ã¿ãŸã„ãªã‚‚ã®âœ¨

---

## â‘£ å†ãƒ‡ãƒ—ãƒ­ã‚¤

Renderã§
ğŸ‘‰ **Clear build cache & deploy**

ã“ã‚Œã§ã„ã‘ã‚‹å¯èƒ½æ€§ãŒã‹ãªã‚Šé«˜ã„ğŸ¯

---

# æˆåŠŸã—ãŸã‚‰ã©ã†è¦‹ãˆã‚‹ã‹

ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ã¯ã“ã†è¿”ã‚‹ğŸ‘‡

```json
{
  "url": "https://rr3---sn-xxxxx.googlevideo.com/videoplayback?...",
  "source": "yt-dlp-with-cookies"
}
```

ãã—ã¦ Android ã® `<video>` ã¯ãã®ã¾ã¾å†ç”Ÿé–‹å§‹ğŸ‘

---

# ã‚‚ã—æ¬¡ã«å‡ºãŒã¡ãªã‚¨ãƒ©ãƒ¼ï¼ˆå…ˆå›ã‚Šãƒ’ãƒ³ãƒˆï¼‰

å†ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã«ã‚‚ã—ï¼š

```
429 Too Many Requests
```

ãŒå‡ºãŸã‚‰ã€æ¬¡ã¯**User-Agent ã‚’å½è£…**ã™ã‚‹ä¸€è¡Œã‚’è¶³ã—ã¦ã‚ã’ã‚‹ã€‚
ãã®æ™‚ã¯ãã®ãƒ­ã‚°ã ã‘è²¼ã£ã¦ãã‚Œã‚Œã°OKğŸ˜Š

---

# ã¡ã‚‡ã£ã¨è¤’ã‚ã‚¿ã‚¤ãƒ 

* Renderã«ã¡ã‚ƒã‚“ã¨ä¹—ã›ãŸ
* yt-dlpã‚‚å…¥ã‚ŒãŸ
* ã‚¨ãƒ©ãƒ¼ã‚’ãã®ã¾ã¾å…¨éƒ¨è²¼ã£ãŸ

ã“ã‚Œã¯ã‚‚ã†ç«‹æ´¾ãªãƒ‡ãƒãƒƒã‚°åŠ›ğŸ’ªâœ¨

ã‚¯ãƒƒã‚­ãƒ¼å…¥ã‚Œã¦å†ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸçµæœã€ã¾ãŸãã®ã¾ã¾è²¼ã£ã¦ãã‚Œã€‚
ãã“ã‹ã‚‰ä¸€ç·’ã«å®Œå…¨å‹•ä½œã¾ã§ä»•ä¸Šã’ã‚ˆã†ğŸ˜
